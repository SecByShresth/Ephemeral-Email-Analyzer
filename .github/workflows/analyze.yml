name: Ephemeral Analysis Backend

on:
  workflow_dispatch:
    inputs:
      analysis_type:
        description: 'Type of analysis (full, ip, domain)'
        required: true
        default: 'full'
      payload:
        description: 'Headers or IPs to analyze'
        required: true

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run Analysis
        id: analysis
        run: |
          # Create a temporary script to run the same logic as the frontend
          cat << 'EOF' > backend_analyzer.js
          const fs = require('fs');
          // Basic mock of the classes used in frontend
          class Analyzer {
              static analyze(type, data) {
                  // Stub for logic - in a real implementation we'd share the JS files
                  return {
                      type: type,
                      timestamp: new Date().toISOString(),
                      summary: "Analysis performed via GitHub Actions backend.",
                      result: "Success"
                  };
              }
          }
          const type = process.argv[2];
          const data = process.argv[3];
          console.log(JSON.stringify(Analyzer.analyze(type, data), null, 2));
          EOF
          
          # Run it
          node backend_analyzer.js "${{ github.event.inputs.analysis_type }}" "${{ github.event.inputs.payload }}" > report.json
          
      - name: Generate Job Summary
        run: |
          echo "## Analysis Report" >> $GITHUB_STEP_SUMMARY
          echo "Type: ${{ github.event.inputs.analysis_type }}" >> $GITHUB_STEP_SUMMARY
          echo "Status: Completed" >> $GITHUB_STEP_SUMMARY
          # Sensitive data is NOT echoed to avoid logs
          
      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: analysis-report
          path: report.json
          retention-days: 1
